{% extends "layout.html" %}

{% block content %}
<title>At Arabası Takip Sistemi Kameralar</title>
<div class="center-content">
  <h3 style="color: white;">Kameralar</h3>
</div>
<p class="space"></p>
{% if msg %}
{% if msg == 'Takip başladı' %}
<div class="mt-3 alert alert-success">
    {{ msg }}
</div>
{% elif msg == 'Takip sona erdi' %}
<div class="mt-3 alert alert-danger">
    {{ msg }}
</div>
{% else %}
<div class="mt-3 alert alert-secondary">
    {{ msg }}
</div>
{% endif %}
{% endif %}
<div style="text-align: center;">
  <div style="display: inline-block; margin: 0 10px;">
    <form action="/camfeed/start_detection/" method="post">
      <button type="submit" class="btn btn-success">Takibi Başlat</button>
    </form>
  </div>
  <div style="display: inline-block; margin: 0 10px;">
    <form action="/camfeed/stop_detection/" method="post">
      <button type="submit" class="btn btn-danger">Takibi Bitir</button>
    </form>
  </div>
</div>
<div class="detection-log-panel">
  <h4 class="log-header" style="color: white;">Takip Kaydı</h4>
  <div class="log-scroll-container">
    <ul class="log-list">
    </ul>
  </div>
</div>
<p class="space-cam"></p>
<p class="space-cam"></p>
<div class="row">
  {% for cam_index in range(1, num_cameras + 1) %}
    <div class="col-md-6">
      <h5 style="color: white;">Kamera {{ cam_index }}</h5>
      <div class="video-container">
        <img src="{{ '/camfeed/stream_camera/' ~ cam_index }}" alt="Camera Feed" style="border: 4px solid lightslategray">
      </div>
      <p class="space-cam"></p>
      <div class="button-container">
        <a href="{{ '/camfeed/adjust_roi/' ~ cam_index }}" class="btn btn-primary">ROI Ayarla</a>
      </div>
    </div>

  {% endfor %}
</div>
<script>
    const eventSource = new EventSource('/camfeed/get_detection_log');
    const logList = document.querySelector('.log-list');
    let latestDisplayedMessage = null;

    eventSource.onmessage = function(event) {
        const newLogEntry = document.createElement('li');
        newLogEntry.className = 'log-entry';
        newLogEntry.textContent = event.data;

        if (event.data !== latestDisplayedMessage) {
            logList.prepend(newLogEntry);
            latestDisplayedMessage = event.data;
        }
    };
</script>
{% endblock %}
